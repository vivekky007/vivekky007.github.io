<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Two-Player Snake</title>
<style>
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
body{display:flex;flex-direction:column;gap:10px;padding:20px}
canvas{background:#0b2b1a;border:4px solid #063;display:block;margin:auto}
#chatWrap{display:flex;flex-direction:column;gap:5px;width:400px;margin:auto}
#chatLog{height:150px;overflow:auto;background:#111;color:#ddd;padding:8px;border-radius:6px}
#chatInput{padding:8px;border-radius:6px;border:1px solid #ccc}
button{padding:8px;border-radius:6px}
</style>
</head>
<body>

<canvas id="game" width="400" height="400"></canvas>

<div id="chatWrap">
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="Type a message..." />
  <button id="chatSendBtn">Send</button>
</div>

<script>
/* ---------------- LOGGING ---------------- */
function log(msg){
  console.log(msg);
}

/* ---------------- GAME SETUP ---------------- */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const cell=20;
const cols=canvas.width/cell;
const rows=canvas.height/cell;

let gameState=null;
let playerId=null; // 'A' or 'B'
let isHost=false;
let hostInterval=null;

const colors={A:'#4ce',B:'#e44',apple:'#ff0'};

const chatLog=document.getElementById('chatLog');
const chatInput=document.getElementById('chatInput');
const chatSendBtn=document.getElementById('chatSendBtn');

function addChatMessage(sender,message){
  const div=document.createElement('div');
  div.textContent=`${sender}: ${message}`;
  chatLog.appendChild(div);
  chatLog.scrollTop=chatLog.scrollHeight;
}

/* ---------------- RN BRIDGE ---------------- */
function sendToNative(obj){
  try{
    if(window.ReactNativeWebView && window.ReactNativeWebView.postMessage){
      window.ReactNativeWebView.postMessage(JSON.stringify(obj));
    }
  }catch(e){ console.warn('postMessage failed',e); }
}

window.onPeerMessage=function(msg){
  if(!msg) return;

  if(msg.type==='assign'){ 
    playerId=msg.player; 
    isHost=msg.player==='A';
    log('Assigned player: '+playerId+(isHost?' (host)':''));
    if(isHost && msg.startImmediately) startGame(true);
    return;
  }

  if(msg.type==='start'){ startGame(msg.host); return; }
  if(msg.type==='state'){ gameState=msg.state; render(gameState); return; }
  if(msg.type==='dir' && msg.player && gameState?.snakes[msg.player]){
    const cur=gameState.snakes[msg.player].dir;
    const nd=msg.dir;
    if(!(cur.x===-nd.x && cur.y===-nd.y)) gameState.snakes[msg.player].dir=nd;
    return;
  }
  if(msg.type==='message'){
    addChatMessage(msg.player,msg.text);
    return;
  }
}

/* ---------------- GAME FUNCTIONS ---------------- */
function resetState(){
  return {
    running:false,
    tick:0,
    snakes:{
      A:{dir:{x:1,y:0},body:[{x:2,y:10},{x:1,y:10},{x:0,y:10}]},
      B:{dir:{x:-1,y:0},body:[{x:17,y:9},{x:18,y:9},{x:19,y:9}]}
    },
    apple:{x:Math.floor(cols/2),y:Math.floor(rows/2)}
  };
}

function startGame(asHost=false){
  if(gameState?.running) return;
  gameState=resetState();
  isHost=asHost;
  if(isHost) hostLoop();
  gameState.running=true;
}

function hostLoop(){
  if(hostInterval) clearInterval(hostInterval);
  hostInterval=setInterval(()=>{
    tick();
    broadcastState();
  },150);
}

function tick(){
  if(!gameState.running) return;
  gameState.tick++;
  for(const pid of ['A','B']){
    const snake=gameState.snakes[pid];
    const head={x:snake.body[0].x+snake.dir.x, y:snake.body[0].y+snake.dir.y};
    head.x=(head.x+cols)%cols;
    head.y=(head.y+rows)%rows;
    snake.body.unshift(head);
    if(head.x===gameState.apple.x && head.y===gameState.apple.y) placeApple();
    else snake.body.pop();
  }
  if(checkCollision('A') || checkCollision('B')){
    gameState.running=false;
    log('Collision! Game over.');
  }
  render(gameState);
}

function checkCollision(pid){
  const s=gameState.snakes[pid];
  const head=s.body[0];
  for(let i=1;i<s.body.length;i++) if(s.body[i].x===head.x && s.body[i].y===head.y) return true;
  const other=pid==='A'?gameState.snakes['B']:gameState.snakes['A'];
  for(let j=0;j<other.body.length;j++) if(other.body[j].x===head.x && other.body[j].y===head.y) return true;
  return false;
}

function placeApple(){
  let x,y,ok;
  do{
    x=Math.floor(Math.random()*cols);
    y=Math.floor(Math.random()*rows);
    ok=true;
    for(const pid of ['A','B']){
      if(gameState.snakes[pid].body.some(b=>b.x===x && b.y===y)){ ok=false; break; }
    }
  }while(!ok);
  gameState.apple={x,y};
}

function render(state){
  if(!state) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawCell(state.apple.x,state.apple.y,colors.apple);
  for(const pid of ['A','B']){
    const sn=state.snakes[pid];
    for(let i=0;i<sn.body.length;i++){
      const c=i===0?shade(colors[pid],-20):colors[pid];
      drawCell(sn.body[i].x,sn.body[i].y,c);
    }
  }
}

function drawCell(x,y,color){
  ctx.fillStyle=color;
  ctx.fillRect(x*cell+1,y*cell+1,cell-2,cell-2);
}

function shade(hex,percent){
  const num=parseInt(hex.replace('#',''),16);
  const amt=Math.round(2.55*percent);
  let R=(num>>16)+amt, G=(num>>8&0x00FF)+amt, B=(num&0x0000FF)+amt;
  R=R<255?R<0?0:R:255; G=G<255?G<0?0:G:255; B=B<255?B<0?0:B:255;
  return '#'+(0x1000000+(R<<16)+(G<<8)+B).toString(16).slice(1);
}

/* ---------------- DIRECTION INPUT ---------------- */
function applyDir(pid,dir){
  const snake=gameState.snakes[pid];
  if(snake.dir.x===-dir.x && snake.dir.y===-dir.y) return;
  snake.dir=dir;
}

function sendDir(dir){
  if(isHost){
    applyDir(playerId,dir);
  } else {
    sendToNative({action:'dir',player:playerId,dir});
  }
}

document.addEventListener('keydown',e=>{
  switch(e.key){
    case 'ArrowUp': sendDir({x:0,y:-1}); break;
    case 'ArrowDown': sendDir({x:0,y:1}); break;
    case 'ArrowLeft': sendDir({x:-1,y:0}); break;
    case 'ArrowRight': sendDir({x:1,y:0}); break;
    case 'w': sendDir({x:0,y:-1}); break;
    case 's': sendDir({x:0,y:1}); break;
    case 'a': sendDir({x:-1,y:0}); break;
    case 'd': sendDir({x:1,y:0}); break;
  }
});

/* ---------------- CHAT ---------------- */
chatSendBtn.onclick=()=>{
  const msg=chatInput.value.trim();
  if(!msg || !playerId) return;
  addChatMessage('You',msg);
  sendToNative({action:'message',player:playerId,text:msg});
  chatInput.value='';
}

/* ---------------- INIT ---------------- */
render(resetState());
sendToNative({action:'ready'});
</script>
</body>
</html>
